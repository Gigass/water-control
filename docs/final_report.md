# 水箱液位控制项目详尽报告

文件：`docs/final_report.md`  
图像：仓库根目录 `Tank Level Control.png`

---

## 1. 题目理解与构思
### 1.1 题目要求
- 单水箱，具有进水口、出水口，通过压力传感器反馈液位。
- 通过调节出水口电动阀门，实现水位稳定在设定值附近。
- 需基于 MATLAB（含 Simulink）实现可视化仿真与控制策略验证。

### 1.2 关键物理关系整理
1. **质量守恒**：`dh/dt = (Q_in - Q_out) / A`
2. **压力-液位换算**：`P = ρ g h`（在仿真中直接以液位作为测量量）
3. **阀门流量**：`Q_out = k_v * u * √h`（`u` 为 0~1 的开度信号）

### 1.3 设计思路
- 搭建一个可调参数的 MATLAB 脚本，快速验证控制思想与调参。
- 用脚本生成 Simulink 模型，保证版本可复现并易于扩展。
- 逐步引入真实因素（噪声、死区、滞后、扰动），在保证可控性的前提下迭代优化。
- 项目整体框架可视化请参考 `docs/system_mindmap.md`（Mermaid 思维导图版本，源自手绘图“输入设定液位 → 控制 → 执行器 → 水箱 → 测量”的流程）。

---

## 2. 初始方案实现
### 2.1 MATLAB 基础脚本（`src/tank_level_sim.m`）
- 固定步长欧拉积分，600 s 仿真。
- 初版控制器：PI + 抗积分饱和，直接调节阀门开度。
- 输入：设定值 0.5 m → 0.65 m 阶跃，进水阶跃扰动 + 高斯噪声。
- 输出：液位与阀门曲线，基本满足闭环但存在较大超调与抖动。

### 2.2 Simulink 自动建模（`src/build_tank_level_model.m`）
- Scripted API 创建 `tank_level_control.slx`，包含 Setpoint、Disturbance、Plant、Controller、Scopes。
- 初版模型与脚本参数一致，便于双平台验证。

---

## 3. 关键优化路径
### 3.1 噪声与扰动建模
- 增加传感器噪声（高斯 2 mm）。
- 引入随机进水扰动 `σ=0.001 m^3/s`，用于检验鲁棒性。
- 在测量端加入一阶低通滤波器（最终 `τ = 3.5 s`）削弱噪声影响。

### 3.2 控制器结构迭代
1. **基础 PI** → **PI + Feedforward**  
   - 通过 `ctrl.ff_gain` 根据设定液位预测维持流量所需开度，以减小稳态偏差。
2. **抗积分饱和**  
   - 当控制信号饱和时停止积分积累，避免风up。
3. **执行器动态**  
   - 添加一阶滞后（最终 `τ = 1.0 s`）及可选死区，模拟阀门惯性与机械特性。

### 3.3 参数调优策略
| 调参阶段 | Kp/Ki | Feedforward | 滤波 τ | 执行器 τ | 结果概要 |
|----------|-------|-------------|--------|----------|----------|
| 初版     | 4.5 / 0.25 | 无 | 无 | 无 | 快速但震荡明显 |
| 中期     | 3.4 / 0.22 | 0.9 | 3.5 s | 0.6 s | 振荡降低但超调仍大 |
| 优化 I   | 2.5 / 0.12 | 无 | 4.5 s | 0.8 s | 平稳但响应偏慢 |
| 优化 II  | 2.0 / 0.10 | 0.6 | 4.0 s | 1.0 s | 平衡速度与稳态 |
| **最终** | **1.8 / 0.12** | **0.5** | **3.5 s** | **1.0 s** | 余振小，调节时间约 200 s |

### 3.4 指标与可视化
- 脚本自动输出：超调、调节时间、IAE、阀门均值/能量，并将数据存于 `tank_level_result`。
- 仿真曲线（液位、阀门、扰动）通过图窗展示；最终图保存为 `Tank Level Control.png`。

---

## 4. 最终效果
### 4.1 仿真结果（见根目录 `Tank Level Control.png`）
- 0~200 s：液位稳定在 0.5 m 左右，噪声抑制效果良好。
- 200 s 阶跃至 0.65 m：最大超调约 0.1 m，振荡逐渐衰减；300 s 左右进入 ±0.02 m 范围。
- 350~450 s 进水扰动增加：阀门输出平滑升高以保持液位；扰动解除后迅速恢复。
- 控制功率（`u^2`）与进水曲线呈良好关联，说明能耗与扰动程度一致。

### 4.2 定量指标（最后一次仿真）
- 最终液位：0.652 m
- 最大超调：≈0.10 m
- 调节时间：≈200~220 s（入 ±0.02 m 带宽）
- IAE：约 25
- 阀门平均开度：≈22%
- 控制能量：≈30（`∫u^2 dt`）

### 4.3 Simulink 版本
- 运行 `build_tank_level_model(true)` 自动生成并仿真；Scope 输出与 MATLAB 脚本一致。
- 模型结构清晰，可进一步扩展（例如加入 MPC、故障注入等）。

---

## 5. 结论与可扩展方向
1. **实现目标**：已构建出一套基于 MATLAB + Simulink 的水箱液位闭环控制方案，具备参数化配置、噪声/扰动建模、性能评估与图形展示。
2. **关键经验**：
   - 适度的前馈有助于稳态精度，但需配合较低的 PI 增益与较慢执行器动态来抑制振荡。
   - 测量滤波与随机扰动必须成对调节，否则控制器对噪声过于敏感。
3. **后续扩展**：
   - 增加多场景测试（多段设定值、传感器故障等）并自动生成统计表格/报告。
   - 将控制算法封装为函数，便于参数扫描和优化算法（遗传算法、MPC）验证。
   - 对接实物硬件或实时仿真平台（Simulink Real-Time / Arduino）进行闭环实验。

---

以上报告总结了从题目理解、模型实现到多轮调优的全过程，可直接作为课程/项目文档提交。***
